åœ¨ Kubernetes ä¸­ï¼Œ**StorageClass** ä¸»è¦ç”¨äº**åŠ¨æ€åˆ›å»º PVï¼ˆPersistentVolumeï¼‰**ï¼Œå› æ­¤å®ƒæœ¬è´¨ä¸Šä¸ä¼šç›´æ¥åœ¨å·²æœ‰çš„ PV ä¸­åŒ¹é… PVCï¼Œè€Œæ˜¯é€šè¿‡ **provisioner** è‡ªåŠ¨ç”Ÿæˆç¬¦åˆ PVC è¦æ±‚çš„ PVï¼Œå¹¶å°†äºŒè€…ç»‘å®šåœ¨ä¸€èµ·ã€‚è®©æˆ‘ä»¬è¯¦ç»†è§£æ StorageClass **å¦‚ä½•åˆ†é…å’Œç»‘å®š PV ä¸ PVC**ï¼š

------

## ğŸ“Œ **1. StorageClass åˆ†é… PV çš„ä¸¤ç§æ–¹å¼**

### âœ… **(1) åŠ¨æ€åˆ›å»º PV**

å½“ PVC æŒ‡å®šäº† `storageClassName`ï¼Œä¸”é›†ç¾¤ä¸­æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„é™æ€ PVï¼ŒKubernetes ä¼šæ ¹æ®å¯¹åº” **StorageClass** çš„é…ç½®ï¼Œé€šè¿‡ `provisioner` **åŠ¨æ€ç”Ÿæˆ** PVã€‚

**åŠ¨æ€åˆ›å»º PV çš„è¿‡ç¨‹**ï¼š

1. ç”¨æˆ·åˆ›å»º PVCï¼ŒæŒ‡å®š `storageClassName`ã€‚

2. Kubernetes æŸ¥æ‰¾æ˜¯å¦æœ‰ç¬¦åˆ PVC è¦æ±‚çš„ 

   é™æ€ PV

   ï¼š

   - è‹¥æ‰¾åˆ°ï¼Œç›´æ¥ç»‘å®š PVC å’Œ PVã€‚
   - è‹¥æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ **StorageClass** ä¸­å®šä¹‰çš„ **provisioner** åŠ¨æ€åˆ›å»º PVã€‚

3. Kubernetes å°†åŠ¨æ€ç”Ÿæˆçš„ PV è‡ªåŠ¨ç»‘å®šåˆ° PVCã€‚

**ç¤ºä¾‹**ï¼š

1ï¸âƒ£ **StorageClass** å®šä¹‰ï¼š

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-storage
provisioner: kubernetes.io/aws-ebs  # AWS EBS åŠ¨æ€æä¾›
parameters:
  type: gp2
reclaimPolicy: Delete
volumeBindingMode: Immediate
```

2ï¸âƒ£ **PVC** è¯·æ±‚ï¼š

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast-storage  # æŒ‡å®š StorageClass
```

3ï¸âƒ£ **ç»‘å®šè¿‡ç¨‹**ï¼š

- Kubernetes å‘ç°æ²¡æœ‰ç¬¦åˆçš„é™æ€ PVã€‚
- ä¾æ® `fast-storage` StorageClassï¼Œä½¿ç”¨ AWS EBS åŠ¨æ€åˆ›å»º 10Gi çš„ PVã€‚
- è‡ªåŠ¨å°†è¯¥ PV ç»‘å®šåˆ° `my-pvc`ã€‚

------

### âœ… **(2) åŒ¹é…å·²æœ‰çš„é™æ€ PV**

å¦‚æœ PVC æŒ‡å®šäº† `storageClassName`ï¼ŒKubernetes ä¹Ÿä¼šä¼˜å…ˆæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„é™æ€ PVï¼Œå¦‚æœæ‰¾åˆ°ï¼Œç›´æ¥è¿›è¡Œç»‘å®šã€‚

**é™æ€ç»‘å®šè¦æ±‚**ï¼š

- PVC å’Œ PV çš„ `storageClassName` å¿…é¡»ç›¸åŒã€‚
- PV çš„å®¹é‡å¿…é¡» **â‰¥ PVC è¯·æ±‚å®¹é‡**ã€‚
- PVC è¯·æ±‚çš„ `accessModes`ï¼ˆè®¿é—®æ¨¡å¼ï¼‰å¿…é¡»ä¸ PV å…¼å®¹ã€‚
- å¦‚æœ PVC ä½¿ç”¨äº† `selector`ï¼Œéœ€ç¬¦åˆ PV æ ‡ç­¾ã€‚

**ç¤ºä¾‹**ï¼š

1ï¸âƒ£ **é™æ€ PV** å®šä¹‰ï¼š

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: static-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-storage  # å¿…é¡»ä¸ PVC å¯¹åº”
  persistentVolumeReclaimPolicy: Retain
  hostPath:
    path: "/mnt/data"
```

2ï¸âƒ£ **PVC** å®šä¹‰ï¼š

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-static-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast-storage
```

3ï¸âƒ£ **ç»‘å®šè¿‡ç¨‹**ï¼š

- Kubernetes å‘ç°å·²æœ‰åä¸º `static-pv` ä¸”ç¬¦åˆæ¡ä»¶çš„ PVã€‚
- ç›´æ¥å°† `my-static-pvc` ç»‘å®šåˆ° `static-pv`ï¼Œè€Œä¸è¿›è¡ŒåŠ¨æ€åˆ›å»ºã€‚

------

## ğŸ“Š **2. å…³é”®å­—æ®µè§£æ**

| å­—æ®µå                 | ä½œç”¨                                       |
| ---------------------- | ------------------------------------------ |
| `storageClassName`     | æ ‡è¯† PVC éœ€è¦åŒ¹é…çš„ StorageClass åç§°ã€‚    |
| `provisioner`          | å®šä¹‰å¦‚ä½•åŠ¨æ€åˆ›å»º PVï¼ˆå¦‚ AWSã€GCEã€NFSï¼‰ã€‚  |
| `parameters`           | åŠ¨æ€åˆ›å»º PV æ‰€éœ€å‚æ•°ï¼ˆå¦‚ç£ç›˜ç±»å‹ã€IOPSï¼‰ã€‚ |
| `volumeBindingMode`    | æ§åˆ¶ PVC å’Œ PV çš„ç»‘å®šæ—¶æœºï¼ˆå³æ—¶æˆ–å»¶è¿Ÿï¼‰ã€‚  |
| `allowVolumeExpansion` | å…è®¸ PVC æ‰©å®¹æ—¶åŠ¨æ€è°ƒæ•´ PV çš„å¤§å°ã€‚        |
| `reclaimPolicy`        | PVC åˆ é™¤åçš„ PV å¤„ç†æ–¹å¼ï¼ˆåˆ é™¤æˆ–ä¿ç•™ï¼‰ã€‚   |

------

## ğŸ“Œ **3. volumeBindingModeï¼šæ§åˆ¶ç»‘å®šæ—¶æœº**

Kubernetes é€šè¿‡ `volumeBindingMode` æ§åˆ¶ PVC å’Œ PV çš„ç»‘å®šæ—¶é—´ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ¨¡å¼ï¼š

| æ¨¡å¼                   | è¯´æ˜                                            | é€‚ç”¨åœºæ™¯                                 |
| ---------------------- | ----------------------------------------------- | ---------------------------------------- |
| `Immediate`ï¼ˆé»˜è®¤ï¼‰    | **ç«‹å³ç»‘å®š**ï¼ŒPVC åˆ›å»ºæ—¶ç«‹å³æœç´¢æˆ–åŠ¨æ€ç”Ÿæˆ PVã€‚ | é€‚ç”¨äº**å•èŠ‚ç‚¹**æˆ–å…±äº«å­˜å‚¨ã€‚             |
| `WaitForFirstConsumer` | **å»¶è¿Ÿç»‘å®š**ï¼Œç›´åˆ° Pod è°ƒåº¦åˆ°èŠ‚ç‚¹åæ‰ç»‘å®š PVã€‚  | é€‚ç”¨äº**å¤šèŠ‚ç‚¹**ç¯å¢ƒï¼Œé¿å…å­˜å‚¨ä½ç½®é”™è¯¯ã€‚ |

### ç¤ºä¾‹ï¼š

```yaml
volumeBindingMode: WaitForFirstConsumer
```

- **Immediate**ï¼šé€‚ç”¨äº NFSã€CephFSï¼Œå› å…¶ä¸èŠ‚ç‚¹æ— å…³ã€‚
- **WaitForFirstConsumer**ï¼šé€‚ç”¨äº AWS EBSã€GCE PDï¼Œé¿å…åœ¨é”™è¯¯èŠ‚ç‚¹ç»‘å®šã€‚

------

## ğŸ“Œ **4. StorageClass åŒ¹é… PVC çš„æ¡ä»¶**

1. **storageClassName**ï¼šPVC å’Œ PV çš„ `storageClassName` å¿…é¡»ä¸€è‡´ã€‚
2. **å®¹é‡**ï¼šPV çš„ `capacity.storage` â‰¥ PVC è¯·æ±‚çš„å­˜å‚¨é‡ã€‚
3. **è®¿é—®æ¨¡å¼**ï¼šPVC çš„ `accessModes` å¿…é¡»ä¸ PV æä¾›çš„ä¸€è‡´æˆ–å…¼å®¹ã€‚
4. **æ ‡ç­¾é€‰æ‹©å™¨**ï¼ˆå¯é€‰ï¼‰ï¼šPVC å¦‚æœæŒ‡å®š `selector`ï¼ŒPV å¿…é¡»æ»¡è¶³å¯¹åº”æ ‡ç­¾ã€‚

------

## ğŸ“Œ **5. ç»‘å®šè¿‡ç¨‹è¯¦ç»†æµç¨‹å›¾**

1. ç”¨æˆ·æäº¤ PVCï¼š
   - æ˜¯å¦æŒ‡å®š `storageClassName`ï¼Ÿ
2. Kubernetes æ£€æŸ¥å·²æœ‰ PVï¼š
   - å¦‚æœæœ‰ç¬¦åˆæ¡ä»¶çš„ PVï¼Œç›´æ¥ç»‘å®šã€‚
3. å¦‚æœæ²¡æœ‰ç¬¦åˆçš„ PVï¼š
   - å¦‚æœ PVC æŒ‡å®šäº† `storageClassName`ï¼Œæ ¹æ®è¯¥ `StorageClass` åŠ¨æ€åˆ›å»º PVã€‚
4. PV å’Œ PVC ç»‘å®šï¼š
   - çŠ¶æ€æ›´æ–°ä¸º `Bound`ã€‚

------

## ğŸ“Œ **6. å¸¸è§é—®é¢˜ä¸æ’æŸ¥**

1. PVC ä¸€ç›´å¤„äº `Pending` çŠ¶æ€
   - PVC æ˜¯å¦æŒ‡å®šäº†é”™è¯¯çš„ `storageClassName`ï¼Ÿ
   - PV çš„å®¹é‡æ˜¯å¦å°äº PVC è¯·æ±‚ï¼Ÿ
   - PV å’Œ PVC çš„ `accessModes` æ˜¯å¦ä¸åŒ¹é…ï¼Ÿ
   - å¯¹äº `WaitForFirstConsumer`ï¼ŒPod æ˜¯å¦å·²è¢«è°ƒåº¦ï¼Ÿ

```bash
kubectl get pvc
kubectl describe pvc <pvc-name>
kubectl get pv
```

1. PVC æ— æ³•è‡ªåŠ¨ç»‘å®š
   - ç¡®ä¿ PVC å’Œ PV çš„ `storageClassName` ä¸€è‡´ã€‚
   - ç¡®ä¿ StorageClass çš„ `provisioner` æ­£ç¡®å¹¶ä¸”å·²éƒ¨ç½²ç›¸åº” CSI æ’ä»¶ã€‚

------

## ğŸ“Œ **7. é‡ç‚¹å›é¡¾**

- **StorageClass** é€šè¿‡ **provisioner** åŠ¨æ€åˆ›å»º PV ä¾› PVC ä½¿ç”¨ã€‚
- **storageClassName** æ˜¯ PVC å’Œ PV åŒ¹é…çš„æ ¸å¿ƒå­—æ®µã€‚
- **volumeBindingMode** æ§åˆ¶ PV ç»‘å®šæ—¶æœºï¼Œå½±å“å¤šèŠ‚ç‚¹è°ƒåº¦ã€‚
- å…ˆåŒ¹é…é™æ€ PVï¼Œä¸å­˜åœ¨æ—¶æŒ‰ StorageClass è‡ªåŠ¨åˆ›å»º PVã€‚